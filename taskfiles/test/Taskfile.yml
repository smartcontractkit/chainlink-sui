version: "3"

tasks:
  default:
    desc: "Run unit and integration tests"
    cmds:
      - task: unit
      - task: integration

  unit:
    desc: "Run unit tests"
    cmds:
      - for:
          matrix:
            MODULE: [".", "./relayer"]
        cmd: cd {{ .ITEM.MODULE }} && go test {{.CLI_ARGS}} -tags="unit" ./...

  integration-setup:
    desc: "Setup required for integration tests"
    cmds:
      - echo "Setting up integration test environment"
      - sui genesis --force --with-faucet

  bindings:
    desc: "Run bindings tests"
    cmds:
      - go test -v ./bindings/... -tags="integration"

  operations:
    desc: "Run operation tests"
    cmds:
      - go test -v ./ops/... -count=1 -p=1 -tags="integration"

  integration:
    desc: "Run integration tests"
    deps: [integration-setup]
    cmds:
      - for:
          matrix:
            MODULE: [".", "./relayer"]
        cmd: cd {{ .ITEM.MODULE }} && go test {{.CLI_ARGS}} -p=1 -count=1 -tags="integration" ./...

  integration-testnet:
    desc: "Run integration tests in testnet"
    deps: [integration-setup]
    cmds:
      - for:
          matrix:
            MODULE: [".", "./relayer"]
        cmd: cd {{ .ITEM.MODULE }} && go test {{.CLI_ARGS}} -p=1 -tags="integration testnet" ./...

  integration-with-db:
    desc: "Run integration tests with database"
    vars:
      TEST_DB_URL: '{{.TEST_DB_URL | default "postgres://localhost:5432/chainlink_test?sslmode=disable&user=postgres&password=postgres"}}'
    cmds:
      - for:
          matrix:
            MODULE: [".", "./relayer"]
        cmd: cd {{ .ITEM.MODULE }} && TEST_DB_URL={{.TEST_DB_URL}} go test {{.CLI_ARGS}} -count=1 -p=1 -tags="integration" ./...
