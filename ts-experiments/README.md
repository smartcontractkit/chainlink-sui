# Sui PTB Experiments

This TypeScript project replicates the Programmable Transaction Block (PTB) operations from the Go test `receiver_test.go` using the official Sui SDK.

## Overview

The main script (`src/ptb-offramp.ts`) performs the same CCIP offramp execution flow as the Go test:

1. **DummyInitExecute**: Initializes execution with message parameters
2. **Create Token Pool Vector**: Creates an empty vector for token transfer completions  
3. **FinishExecuteWithArgs**: Completes the execution with the hot potato and token pool vector
4. **Event Processing**: Reads and decodes transaction events to verify execution

## ðŸš€ Quick Start

### Step 1: Deploy Contracts (Go Test)
First, deploy the contracts using the Go test to generate the deployment state:

```bash
cd relayer/chainwriter/ptb/offramp/receiver
go test -v -run TestReceiver
```

This will create `state.json` in the project root with all the deployed contract details.

### Step 2: Validate State
```bash
cd ts-experiments
npm install
npm run validate-state
```

### Step 3: Run TypeScript PTB
```bash
npm start
```

## Key Components

### OfframpPTBExecutor Class
- Manages Sui client connection and keypair
- Constructs and executes the PTB transaction
- Processes transaction events and results

### Configuration
The script requires several configuration parameters that match your deployed contracts:

```typescript
interface OfframpConfig {
  ccipPackageId: string;      // Your CCIP package ID
  offrampPackageId: string;   // Your offramp package ID  
  receiverPackageId: string;  // Your receiver package ID
  ccipObjectRef: string;      // CCIP object reference ID
  offrampState: string;       // Offramp state object ID
  suiUrl: string;            // Sui network URL
  privateKeyB64?: string;     // Optional private key in base64
}
```

## Available Scripts

- `npm start` - Run the main PTB script

## Automatic Configuration

The TypeScript script automatically loads contract details from `state.json` in the project root (generated by the Go test). If this file doesn't exist, it falls back to environment variables:

```bash
# Optional environment variables (fallback only)
CCIP_PACKAGE_ID=0x...
OFFRAMP_PACKAGE_ID=0x...
RECEIVER_PACKAGE_ID=0x...
CCIP_OBJECT_REF=0x...
OFFRAMP_STATE=0x...
SUI_URL=http://localhost:9000
PRIVATE_KEY_B64=...  # Optional
```

## PTB Flow Details

### Step 1: DummyInitExecute
```typescript
const initExecuteResult = txb.moveCall({
  target: `${offrampPackageId}::offramp::dummy_init_execute`,
  arguments: [
    txb.object(offrampState),
    txb.pure(sourceChainSelector, 'u64'),
    txb.pure(Array.from(messageId), 'vector<u8>'),
    txb.pure(senderBytes, 'vector<u8>'),
    txb.pure(Array.from(data), 'vector<u8>')
  ]
});
```

### Step 2: Create Empty Token Pool Vector
```typescript
const tokenPoolPotatoes = txb.makeMoveVec({
  type: `${ccipPackageId}::offramp_state_helper::CompletedDestTokenTransfer`,
  objects: []
});
```

### Step 3: FinishExecuteWithArgs  
```typescript
txb.moveCall({
  target: `${offrampPackageId}::offramp::finish_execute`,
  arguments: [
    txb.object(offrampState),
    initExecuteResult,  // Hot potato from step 1
    tokenPoolPotatoes   // Empty vector from step 2
  ]
});
```

## Event Processing

The script processes transaction events to find and decode the "Hello World" message, similar to the Go test:

```typescript
if (eventData.data && Array.isArray(eventData.data)) {
  const dataBytes = new Uint8Array(eventData.data);
  const decodedString = new TextDecoder().decode(dataBytes);
  if (decodedString === "Hello World") {
    console.log('âœ… Found expected "Hello World" message!');
  }
}
```
